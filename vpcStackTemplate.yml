---
AWSTemplateFormatVersion: "2010-09-09"

Description: >
  The template is used to create a VPC with CIDR provided as parameter.

# Metadata:
#   template metadata

Parameters:
  VPCCIDR: 
    Description: The CIDR(/16) value for VPC
    Type: String
    Default: 10.0.0.0/16
    #Regex to check CIDR
    AllowedPattern: ^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}(\/16)$
# (\/([0-9]|[1-2][0-9]|3[0-2]))$  If we need to match CIDR prefix of 0-32
    ConstraintDescription: Please enter a valid CIDR.

# Rules:
#   set of rules

# Mappings:
#   set of mappings

# Conditions:
#   set of conditions

# Transform:
#   set of transforms

Resources:
  myVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VPCCIDR
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: myVPC

  publicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      VpcId: !Ref myVPC
      CidrBlock: 10.0.0.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: PublicSubnetVPC

  privateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      VpcId: !Ref myVPC
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: PrivateSubnetVPC

  privateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !Select [ 1, !GetAZs '' ]
      VpcId: !Ref myVPC
      CidrBlock: 10.0.2.0/24
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: PrivateSubnetVPC

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref myVPC
      Tags:
        - Key: Name
          Value: routeTableVPC

  igwName:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: internetGatewayVPC
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref myVPC
      InternetGatewayId: !Ref igwName
  
  routeName:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref igwName

  routeTableAssocName:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref publicSubnet
      RouteTableId: !Ref PublicRouteTable

  secSSHJumpbox:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: SSHJumpbox
      GroupDescription: Security Group to Allow SSH connections into Jumpbox
      VpcId: !Ref myVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: sg-Jumpbox-SSH

  secSSHPrivate:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: SSHPrivateInstances
      GroupDescription: Security Group to Allow SSH connections into Private Instances
      VpcId: !Ref myVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourceSecurityGroupId: !GetAtt secSSHJumpbox.GroupId
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          DestinationSecurityGroupId: !GetAtt secSSHJumpbox.GroupId
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          DestinationSecurityGroupId: !GetAtt secSSHJumpbox.GroupId
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          DestinationSecurityGroupId: !GetAtt secSSHJumpbox.GroupId
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: sg-Private-SSH

  secDBPrivate:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: SSHPrivateDB
      GroupDescription: Security Group to Allows to connect to RDS from ec2
      VpcId: !Ref myVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !GetAtt secSSHJumpbox.GroupId
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !GetAtt secSSHPrivate.GroupId
      # SecurityGroupEgress:
      #   - IpProtocol: tcp
      #     FromPort: 22
      #     ToPort: 22
      #     DestinationSecurityGroupId: !GetAtt secSSHJumpbox.GroupId
      Tags:
        - Key: Name
          Value: sg-Private-DB
          
  jumpBoxEC2:
    Type: AWS::EC2::Instance
    Properties:
      KeyName: jumpbox
      ImageId: ami-09d3b3274b6c5d4aa
      InstanceType: t2.micro
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      SubnetId: !Ref publicSubnet
      SecurityGroupIds:
        - !Ref secSSHJumpbox
      Tags:
        - Key: Name
          Value: jumpBox    

  webServerEc2:
    Type: AWS::EC2::Instance
    Properties:
      KeyName: jumpbox
      ImageId: ami-09d3b3274b6c5d4aa
      InstanceType: t2.micro
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      SubnetId: !Ref privateSubnet
      SecurityGroupIds:
        - !Ref secSSHPrivate
      Tags:
        - Key: Name
          Value: webServer    


  rdsDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for RDS Instance
      SubnetIds:
        - !Ref privateSubnet
        - !Ref privateSubnet1

  rdsDBInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      AllocatedStorage: 20
      DBInstanceClass: db.t3.micro
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      BackupRetentionPeriod: 0
      DBInstanceIdentifier: production-database
      DBSubnetGroupName: !Ref rdsDBSubnetGroup
      Engine: mysql
      EngineVersion: 8.0.28
      # KmsKeyId: 
      # LicenseModel: 
      MasterUsername: admin
      MasterUserPassword: password
      MultiAZ: false
      # OptionGroupName: 
      Port: 3306
      EnablePerformanceInsights: false
      # PreferredBackupWindow: 
      # PreferredMaintenanceWindow: 
      PubliclyAccessible: false
      # SourceDBInstanceIdentifier: 
      StorageEncrypted: false
      StorageType: gp2
      VPCSecurityGroups:
        - !Ref secDBPrivate
      Tags:
        - Key: Name
          Value: database-1

# Outputs:
#   set of outputs